<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Department Analytics | KNMIET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="p-8" onload="loadAnalytics()">
    <div class="max-w-7xl mx-auto space-y-8">

        <div class="flex justify-between items-center p-8 glass rounded-[2.5rem] border-l-4 border-blue-500">
            <div>
                <h1 class="text-3xl font-black">HOD Analytics Dashboard</h1>
                <p class="text-xs text-blue-400 font-bold uppercase tracking-widest mt-1">Real-Time Student Monitoring
                </p>
            </div>
            <div class="flex gap-4">
                <input type="text" id="search" placeholder="Search by Name/Roll..." oninput="filter()"
                    class="bg-slate-900 border border-slate-700 p-3 rounded-xl text-xs outline-none focus:border-blue-500 w-64 text-white">
                <a href="admin.html"
                    class="bg-slate-800 px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 transition-all uppercase tracking-widest">âž”
                    Back</a>
            </div>
        </div>

        <div class="glass rounded-[2.5rem] overflow-hidden border border-slate-800 shadow-2xl">
            <table class="w-full text-left">
                <thead class="bg-slate-900/80">
                    <tr class="text-[10px] text-slate-500 uppercase tracking-widest border-b border-slate-800">
                        <th class="p-6">Student Information</th>
                        <th class="p-6">Branch & Year</th>
                        <th class="p-6 text-center">Total Attendance</th>
                        <th class="p-6 text-right">Hardware Control</th>
                    </tr>
                </thead>
                <tbody id="analyticsBody" class="divide-y divide-slate-800/50"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API = "https://knmiet-attendance-core.onrender.com";
        const key = localStorage.getItem('admin_key') || "KNM@2026!Admin";
        let allStudents = [];

        async function loadAnalytics() {
            try {
                const res = await fetch(`${API}/all-students-analytics?admin_key=${key}`);
                allStudents = await res.json();
                render(allStudents);
            } catch (e) { alert("Verification Failed. Please log in again."); }
        }

        function render(list) {
            document.getElementById('analyticsBody').innerHTML = list.map(s => `
                <tr class="hover:bg-blue-900/5 transition-all">
                    <td class="p-6">
                        <p class="font-bold text-white text-sm">${s.name}</p>
                        <p class="text-[10px] font-mono text-slate-500 mt-1">ROLL: ${s.roll_no} | ERP: ${s.erp_id}</p>
                    </td>
                    <td class="p-6">
                        <span class="bg-blue-900/30 text-blue-400 px-3 py-1 rounded-lg text-[10px] font-black uppercase">${s.branch} Yr ${s.year}</span>
                    </td>
                    <td class="p-6 text-center">
                        <p class="text-lg font-black text-emerald-400">${s.total_lectures}</p>
                        <p class="text-[8px] text-slate-500 uppercase font-bold">Total Lectures</p>
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="resetDevice('${s.roll_no}')" class="bg-orange-600/20 text-orange-400 border border-orange-900/50 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-tighter hover:bg-orange-600 hover:text-white transition-all">Reset Device ID</button>
                    </td>
                </tr>`).join('');
        }

        function filter() {
            const q = document.getElementById('search').value.toLowerCase();
            render(allStudents.filter(s => s.name.toLowerCase().includes(q) || s.roll_no.includes(q)));
        }

        async function resetDevice(roll) {
            if (confirm("This will allow the student to register from a new phone. Continue?")) {
                await fetch(`${API}/reset-student-device?roll_no=${roll}&admin_key=${key}`, { method: 'POST' });
                alert("Device security lock released."); loadAnalytics();
            }
        }
    </script>
</body>

</html>