<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Analytics | KNMIET ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
            }

            .glass {
                border: none !important;
                backdrop-filter: none !important;
                background: transparent !important;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8" onload="loadAnalytics()">

    <div class="max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
        <div
            class="flex flex-col md:flex-row justify-between items-center p-6 md:p-10 glass rounded-[2.5rem] border-l-4 border-blue-600 bg-slate-900/50 no-print">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-black">HOD Analytics</h1>
                <p class="text-xs text-blue-400 font-bold uppercase tracking-widest mt-1">Attendance & Academic Records
                </p>
            </div>
            <div class="flex flex-wrap justify-center gap-3 mt-6 md:mt-0">
                <button onclick="exportToCSV()"
                    class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-emerald-900/20">Download
                    Excel</button>
                <button onclick="window.print()"
                    class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-blue-900/20">Export
                    PDF</button>
                <a href="admin.html"
                    class="bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest border border-slate-700 transition-all">Back</a>
            </div>
        </div>

        <div class="max-w-md no-print">
            <input type="text" id="searchBox" oninput="filterData()" placeholder="Search Student Name or Roll Number..."
                class="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl outline-none focus:border-blue-500 transition-all text-sm">
        </div>

        <div class="glass rounded-[2.5rem] overflow-hidden border border-slate-800 shadow-2xl overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-950 text-slate-400 text-[10px] uppercase tracking-widest">
                    <tr>
                        <th class="p-6">Student Info</th>
                        <th class="p-6">Branch/Year</th>
                        <th class="p-6 text-center">Attendance %</th>
                        <th class="p-6 text-right no-print">Action</th>
                    </tr>
                </thead>
                <tbody id="analyticsBody" class="divide-y divide-slate-800/50">
                </tbody>
            </table>
        </div>
    </div>

    <div id="dossierModal"
        class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-2xl p-8 rounded-[3rem] border-t-4 border-blue-500 shadow-2xl relative">
            <button onclick="closeDossier()"
                class="absolute top-8 right-8 text-slate-500 hover:text-white font-black">âœ•</button>
            <h2 id="dossierName" class="text-2xl font-black mb-1">Student Name</h2>
            <p id="dossierRoll" class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-8"></p>

            <div id="dossierContent" class="space-y-4 max-h-[450px] overflow-y-auto pr-2 custom-scroll">
            </div>
        </div>
    </div>

    <script>
        const API = "https://knmiet-attendance-core.onrender.com";
        const key = localStorage.getItem('admin_key');
        let allStudents = [];

        async function loadAnalytics() {
            try {
                const res = await fetch(`${API}/all-students-analytics?admin_key=${key}`);
                allStudents = await res.json();

                // Fetch extra ERP details (marks/attendance) for each student
                for (let s of allStudents) {
                    const erpRes = await fetch(`${API}/student-erp-data?roll_no=${s.roll_no}`);
                    s.erp = await erpRes.json();
                }

                renderTable(allStudents);
            } catch (e) {
                console.error("Failed to load analytics", e);
            }
        }

        function renderTable(data) {
            const body = document.getElementById('analyticsBody');
            body.innerHTML = data.map(s => {
                // Calculate percentage based on attended vs total held across all subjects
                let totalAttended = 0;
                let totalHeld = 0;
                s.erp.subjects.forEach(sub => {
                    totalAttended += sub.attended;
                    totalHeld += sub.total_held;
                });

                const percent = totalHeld > 0 ? Math.round((totalAttended / totalHeld) * 100) : 0;
                const colorClass = percent < 75 ? 'text-red-500' : 'text-emerald-400';

                return `
                <tr class="hover:bg-blue-900/5 transition-colors">
                    <td class="p-6">
                        <p class="font-bold text-sm text-white">${s.name}</p>
                        <p class="text-[10px] text-slate-500 font-mono mt-0.5">${s.roll_no}</p>
                    </td>
                    <td class="p-6">
                        <span class="bg-slate-800 text-slate-300 px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest">${s.branch} - YR ${s.year}</span>
                    </td>
                    <td class="p-6 text-center">
                        <p class="text-xl font-black ${colorClass}">${percent}%</p>
                        <p class="text-[8px] text-slate-500 uppercase font-bold">${totalAttended}/${totalHeld} Lectures</p>
                    </td>
                    <td class="p-6 text-right no-print">
                        <button onclick="openDossier('${s.roll_no}')" class="bg-blue-600/10 text-blue-400 border border-blue-600/20 px-4 py-2 rounded-xl text-[9px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all">View Marks</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterData() {
            const q = document.getElementById('searchBox').value.toLowerCase();
            const filtered = allStudents.filter(s => s.name.toLowerCase().includes(q) || s.roll_no.includes(q));
            renderTable(filtered);
        }

        function openDossier(roll) {
            const s = allStudents.find(x => x.roll_no === roll);
            document.getElementById('dossierName').innerText = s.name;
            document.getElementById('dossierRoll').innerText = `ROLL: ${s.roll_no} | ${s.branch} YEAR ${s.year}`;

            document.getElementById('dossierContent').innerHTML = s.erp.subjects.map(sub => `
                <div class="glass p-5 rounded-[2rem] border border-slate-800/80">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest">${sub.code}</p>
                            <p class="font-bold text-sm">${sub.subject_name}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-lg text-emerald-400">${sub.total_held > 0 ? Math.round((sub.attended / sub.total_held) * 100) : 0}%</p>
                            <p class="text-[8px] text-slate-500 uppercase font-bold">${sub.attended}/${sub.total_held} Attended</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-slate-950 p-2 rounded-xl text-center border border-slate-800">
                            <p class="text-[8px] text-slate-500 uppercase mb-1">Sess 1</p>
                            <p class="font-black text-xs text-blue-400">${sub.s1}</p>
                        </div>
                        <div class="bg-slate-950 p-2 rounded-xl text-center border border-slate-800">
                            <p class="text-[8px] text-slate-500 uppercase mb-1">Sess 2</p>
                            <p class="font-black text-xs text-blue-400">${sub.s2}</p>
                        </div>
                        <div class="bg-slate-950 p-2 rounded-xl text-center border border-slate-800">
                            <p class="text-[8px] text-slate-500 uppercase mb-1">PUT</p>
                            <p class="font-black text-xs text-blue-400">${sub.put}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('dossierModal').classList.remove('hidden');
        }

        function closeDossier() {
            document.getElementById('dossierModal').classList.add('hidden');
        }

        function exportToCSV() {
            let csv = "Student Name,Roll Number,Branch,Year,Overall Attendance %\n";
            allStudents.forEach(s => {
                let att = 0; let held = 0;
                s.erp.subjects.forEach(sub => { att += sub.attended; held += sub.total_held; });
                let p = held > 0 ? Math.round((att / held) * 100) : 0;
                csv += `"${s.name}",${s.roll_no},${s.branch},${s.year},${p}%\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `KNMIET_Attendance_Report_${new Date().toLocaleDateString()}.csv`);
            a.click();
        }
    </script>
</body>

</html>