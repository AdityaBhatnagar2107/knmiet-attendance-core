<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Portal | KNMIET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scroll::-webkit-scrollbar {
            height: 4px;
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }

        #reader {
            width: 100% !important;
            border: none !important;
        }

        #reader__scan_region {
            background: white;
        }
    </style>
</head>

<body class="p-4 flex flex-col items-center pb-20 relative min-h-screen" onload="checkStatus()">
    <div
        style="position:fixed; top:-20%; left:-10%; width:60%; height:60%; background:radial-gradient(circle, rgba(37,99,235,0.1) 0%, transparent 70%); filter:blur(60px); z-index:-1;">
    </div>
    <div
        style="position:fixed; bottom:-20%; right:-10%; width:60%; height:60%; background:radial-gradient(circle, rgba(147,51,234,0.1) 0%, transparent 70%); filter:blur(60px); z-index:-1;">
    </div>

    <div id="globalLoader"
        class="fixed inset-0 bg-[#020617] z-[9999] flex flex-col items-center justify-center transition-opacity duration-1000">
        <div class="bg-white p-4 rounded-3xl mb-8 animate-pulse shadow-[0_0_30px_rgba(255,255,255,0.1)]"><img
                src="knmiet-logo1494x375.webp" class="h-10 object-contain" alt="Logo"
                onerror="this.src='knmiet-logo.webp'"></div>
        <div class="w-12 h-12 border-4 border-slate-800 border-t-blue-500 rounded-full animate-spin mb-6"></div>
        <p id="loaderText" class="text-xs text-blue-400 font-bold uppercase tracking-widest">Checking Director
            Authorization...</p>
    </div>

    <div id="pendingView"
        class="hidden mt-10 w-full max-w-sm glass p-8 rounded-[3rem] text-center border-t-4 border-yellow-500 shadow-2xl">
        <h2 class="text-xl font-black text-yellow-500">Under Review</h2><button onclick="location.reload()"
            class="mt-8 w-full bg-yellow-600 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest text-white">Refresh
            Status</button>
    </div>
    <div id="rejectedView"
        class="hidden mt-10 w-full max-w-sm glass p-8 rounded-[3rem] text-center border-t-4 border-red-500 shadow-2xl">
        <h2 class="text-xl font-black text-red-500">Request Denied</h2><button onclick="reApply()"
            class="mt-8 w-full bg-slate-800 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest text-white">Re-Apply</button>
    </div>

    <div id="approvedView" class="hidden w-full max-w-md space-y-6 animate-in fade-in duration-500">
        <div class="text-center mt-2 mb-4">
            <div class="bg-white p-3 rounded-2xl inline-block shadow-[0_0_20px_rgba(255,255,255,0.1)]"><img
                    src="knmiet-logo1494x375.webp" class="h-8 object-contain" alt="Logo"
                    onerror="this.src='knmiet-logo.webp'"></div>
        </div>

        <div
            class="glass p-6 rounded-[2rem] border-l-4 border-blue-500 shadow-xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 backdrop-blur-xl">
            <h1 id="sName" class="text-xl font-black truncate text-white drop-shadow-md">Student</h1>
            <div class="flex justify-between items-end mt-2">
                <p id="sBranch" class="text-blue-400 text-[10px] font-bold uppercase tracking-widest"></p>
                <div class="text-right">
                    <p class="text-[8px] text-slate-500 uppercase font-bold">Scans / Leaves</p>
                    <p id="totalLecs"
                        class="text-2xl font-black text-emerald-400 leading-none mt-1 drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]">
                        0 / 0</p>
                </div>
            </div>
        </div>

        <div class="glass p-4 rounded-[2rem] overflow-hidden border border-slate-800 shadow-lg">
            <div id="reader" class="rounded-2xl overflow-hidden"></div>
            <p id="scanMsg"
                class="text-center text-[9px] font-bold uppercase tracking-widest text-slate-500 mt-4 italic">Align QR
                to Mark Attendance</p>
        </div>

        <div class="flex gap-1 bg-slate-900/80 p-1.5 rounded-xl border border-slate-800 backdrop-blur-md">
            <button id="btnOverview" onclick="switchTab('overview')"
                class="w-1/4 py-2.5 rounded-lg text-[9px] font-black uppercase tracking-widest bg-blue-600 text-white transition-all shadow-md">Score</button>
            <button id="btnMatrix" onclick="switchTab('matrix')"
                class="w-1/4 py-2.5 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-500 hover:text-white transition-all">Matrix</button>
            <button id="btnSchedule" onclick="switchTab('schedule')"
                class="w-1/4 py-2.5 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-500 hover:text-white transition-all">Timetable</button>
            <button id="btnLeave" onclick="switchTab('leave')"
                class="w-1/4 py-2.5 rounded-lg text-[9px] font-black uppercase tracking-widest text-purple-400 hover:text-purple-300 transition-all">Leave</button>
        </div>

        <div id="overviewTab" class="space-y-3 pb-10">
            <div id="subjectList" class="space-y-3"></div>
        </div>

        <div id="matrixTab"
            class="hidden overflow-x-auto glass rounded-[1.5rem] border border-slate-800 shadow-xl custom-scroll">
            <table class="w-full text-center border-collapse whitespace-nowrap">
                <thead>
                    <tr id="matrixHeader"
                        class="bg-slate-950/80 text-[9px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-800">
                    </tr>
                </thead>
                <tbody id="matrixBody" class="divide-y divide-slate-800/50 text-xs"></tbody>
            </table>
        </div>

        <div id="scheduleTab" class="hidden space-y-4 pb-10">
            <div id="noticeBanner"
                class="hidden bg-red-950/30 border border-red-500/50 p-4 rounded-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                <p class="text-[9px] font-black text-red-400 uppercase tracking-widest flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Proxy / Notice</p>
                <p id="noticeText" class="text-xs text-red-200 italic leading-relaxed"></p>
            </div>
            <div class="glass p-5 rounded-[2rem] border border-slate-800 shadow-xl overflow-x-auto custom-scroll">
                <h3
                    class="text-[10px] font-bold text-cyan-400 uppercase mb-4 tracking-widest border-b border-slate-800 pb-2">
                    Master Schedule</h3>
                <table class="w-full text-center text-[10px]">
                    <thead class="text-slate-500 uppercase tracking-widest">
                        <tr>
                            <th class="p-2 pb-4">Day</th>
                            <th class="p-2 pb-4">Slot 1</th>
                            <th class="p-2 pb-4">Slot 2</th>
                            <th class="p-2 pb-4">Slot 3</th>
                            <th class="p-2 pb-4">Slot 4</th>
                            <th class="p-2 pb-4">Slot 5</th>
                        </tr>
                    </thead>
                    <tbody id="ttGridDisplay" class="divide-y divide-slate-800/50 text-slate-300"></tbody>
                </table>
            </div>
        </div>

        <div id="leaveTab" class="hidden space-y-4 pb-10">
            <div class="glass p-6 rounded-[2rem] border border-slate-800 shadow-xl">
                <h3
                    class="text-[10px] font-bold text-purple-400 uppercase mb-4 tracking-widest border-b border-slate-800 pb-2">
                    Request Official Leave</h3><input type="date" id="leaveDate"
                    class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-sm outline-none text-slate-400 mb-3 focus:border-purple-500"><textarea
                    id="leaveReason" placeholder="Reason (e.g., Hackathon, Medical Issue...)"
                    class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-sm outline-none text-white h-24 mb-3 focus:border-purple-500"></textarea><button
                    onclick="submitLeave()"
                    class="w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-xl font-black text-[10px] text-white uppercase tracking-widest transition-all shadow-lg shadow-purple-900/50">Submit
                    Request</button>
            </div>
            <div class="glass p-6 rounded-[2rem] border border-slate-800 shadow-xl">
                <h3
                    class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest border-b border-slate-800 pb-2">
                    Leave History</h3>
                <div id="leaveHistory" class="space-y-3 max-h-48 overflow-y-auto custom-scroll pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        // ... (Keep all your existing Student JS here, just replace loadTimetable) ...

        async function loadTimetable(branch, year, section) {
            const groupId = `${branch}-${year}-${section}`;
            try {
                const res = await fetch(`${API}/get-timetable?group_id=${groupId}`);
                const data = await res.json();
                if (data.exists && data.grid_data) {
                    try {
                        const parsed = JSON.parse(data.grid_data);
                        // Show Notice Banner if exists
                        if (parsed.notice && parsed.notice.trim() !== "") {
                            document.getElementById('noticeBanner').classList.remove('hidden');
                            document.getElementById('noticeText').innerText = parsed.notice;
                        } else { document.getElementById('noticeBanner').classList.add('hidden'); }

                        // Render Grid
                        if (parsed.grid) {
                            let rows = "";
                            ["Mon", "Tue", "Wed", "Thu", "Fri"].forEach(day => {
                                rows += `<tr><td class="p-3 font-bold text-blue-400 bg-slate-950/50">${day}</td>`;
                                parsed.grid[day].forEach(slot => { rows += `<td class="p-3 border-l border-slate-800/30">${slot || "-"}</td>`; });
                                rows += `</tr>`;
                            });
                            document.getElementById('ttGridDisplay').innerHTML = rows;
                        }
                    } catch (e) { document.getElementById('ttGridDisplay').innerHTML = `<tr><td colspan="6" class="p-4 text-slate-400">${data.grid_data}</td></tr>`; } // Old data fallback
                } else { document.getElementById('ttGridDisplay').innerHTML = `<tr><td colspan="6" class="p-8 text-slate-500 italic">No timetable published yet.</td></tr>`; }
            } catch (e) { document.getElementById('ttGridDisplay').innerHTML = `<tr><td colspan="6">Error loading schedule.</td></tr>`; }
        }

        // Ensure you keep checkStatus(), loadMatrix(), switchTab(), startScanner() etc. from the previous code block exactly as they were!
    </script>
</body>

</html>