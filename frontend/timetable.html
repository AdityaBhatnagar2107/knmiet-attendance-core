<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Master Timetable | KNMIET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            text-align: center;
        }

        th,
        td {
            border: 1px solid #334155;
            padding: 1rem;
            font-size: 0.875rem;
        }

        th {
            background: #0f172a;
            color: #94a3b8;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td[contenteditable="true"] {
            background: rgba(59, 130, 246, 0.05);
            transition: all 0.2s;
            outline: none;
        }

        td[contenteditable="true"]:focus {
            background: rgba(59, 130, 246, 0.15);
            box-shadow: inset 0 0 0 2px #3b82f6;
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <div class="flex justify-between items-center glass p-8 rounded-[2.5rem] border-l-4 border-blue-500">
            <div>
                <h1 class="text-3xl font-black">Timetable Manager</h1>
                <p class="text-xs text-blue-400 font-bold uppercase tracking-widest mt-1">Grid Publishing System</p>
            </div>
            <a href="admin.html"
                class="bg-slate-800 px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 transition-all uppercase tracking-widest">âž”
                Back</a>
        </div>

        <div class="glass p-6 rounded-3xl border-t-4 border-slate-800 flex gap-4 items-center">
            <select id="ttBranch"
                class="bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-white w-1/3">
                <option value="CSE">Computer Science (CSE)</option>
                <option value="IT">Information Tech (IT)</option>
            </select>
            <select id="ttYear"
                class="bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-white w-1/3">
                <option value="1">1st Year</option>
                <option value="2">2nd Year</option>
                <option value="3">3rd Year</option>
                <option value="4">4th Year</option>
            </select>
            <button onclick="loadGrid()"
                class="w-1/3 bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition-all text-white shadow-lg uppercase tracking-widest text-sm">Load
                Grid</button>
        </div>

        <div class="glass p-8 rounded-[3rem] overflow-x-auto shadow-2xl border border-slate-800">
            <div id="gridContainer">
                <p class="text-center text-slate-500 italic py-10">Select Branch and Year, then click "Load Grid" to
                    begin editing.</p>
            </div>
            <button id="saveBtn" onclick="saveGrid()"
                class="hidden w-full mt-8 bg-emerald-600 py-4 rounded-2xl font-black text-white hover:bg-emerald-500 transition-all shadow-lg uppercase tracking-widest">PUBLISH
                TO STUDENTS</button>
        </div>
    </div>

    <script>
        const API = "https://knmiet-attendance-core.onrender.com";
        const key = localStorage.getItem('admin_key');

        if (!key) {
            alert("Admin session missing. Redirecting to login.");
            window.location.href = "admin.html";
        }

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        function generateEmptyGrid() {
            let html = `<table><thead><tr><th>Day / Time</th><th>09:00 - 10:00</th><th>10:00 - 11:00</th><th>11:00 - 12:00</th><th>12:00 - 01:00</th><th class="bg-slate-800 text-slate-400">01:00 - 01:40</th><th>01:40 - 02:40</th><th>02:40 - 03:40</th><th>03:40 - 04:40</th></tr></thead><tbody>`;

            days.forEach(day => {
                html += `<tr><td class="font-bold bg-slate-900">${day}</td>`;
                for (let i = 0; i < 4; i++) html += `<td contenteditable="true"></td>`;
                html += `<td class="bg-slate-800/50 font-bold text-[10px] text-slate-500 tracking-widest">LUNCH</td>`;
                for (let i = 0; i < 3; i++) html += `<td contenteditable="true"></td>`;
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        async function loadGrid() {
            const branch = document.getElementById('ttBranch').value;
            const year = document.getElementById('ttYear').value;
            const branchYearStr = `${branch}-${year}`; // e.g., CSE-2 (Matches Student side exactly)

            const res = await fetch(`${API}/get-timetable?branch_year=${branchYearStr}`);
            const data = await res.json();

            const container = document.getElementById('gridContainer');
            if (data.exists && data.grid_data) {
                container.innerHTML = data.grid_data;
                // Re-enable editing for Admin
                container.querySelectorAll('td').forEach(td => {
                    if (td.innerText !== "LUNCH" && !td.classList.contains('font-bold')) {
                        td.setAttribute('contenteditable', 'true');
                    }
                });
            } else {
                container.innerHTML = generateEmptyGrid();
            }

            document.getElementById('saveBtn').classList.remove('hidden');
        }

        async function saveGrid() {
            const branch = document.getElementById('ttBranch').value;
            const year = document.getElementById('ttYear').value;
            const branchYearStr = `${branch}-${year}`;

            const htmlData = document.getElementById('gridContainer').innerHTML;

            try {
                const res = await fetch(`${API}/save-timetable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // URL params for POST in FastAPI
                    body: JSON.stringify({}),
                });

                // Since we are using query params in FastAPI, we need to send it via URL
                const queryParams = `branch_year=${encodeURIComponent(branchYearStr)}&grid_data=${encodeURIComponent(htmlData)}&admin_key=${encodeURIComponent(key)}`;

                const finalRes = await fetch(`${API}/save-timetable?${queryParams}`, { method: 'POST' });

                if (finalRes.ok) {
                    alert(`Timetable Published for ${branchYearStr}! Students can now see it.`);
                } else {
                    const err = await finalRes.json();
                    alert(`Publish failed: ${err.detail || 'Server error'}`);
                }
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }
    </script>
</body>

</html>